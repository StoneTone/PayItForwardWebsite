name: Keep RSS Feeds Alive

on:
  schedule:
    - cron: '30 2 */3 * *'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  keep-feeds-alive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fetch RSS Feeds
      run: |
        echo "ðŸ”„ Starting RSS keep-alive process..."
        
        # RSS feed URLs
        UPCOMING_EVENTS="https://fetchrss.com/feed/1vRIs41DtAOA1vRJ6l7Cu1MQ.rss"
        LATEST_NEWS="https://fetchrss.com/feed/1vRIs41DtAOA1vRJ7h57J7QQ.rss"
        
        # Function to fetch and validate RSS feed
        fetch_feed() {
          local url=$1
          local name=$2
          
          echo "ðŸ“¡ Fetching $name..."
          
          # Use simpler approach with just curl
          if response=$(curl -s --max-time 30 \
            -H "User-Agent: PayItForward-KeepAlive/1.0" \
            -H "Accept: application/xml, text/xml, */*" \
            -w "HTTP_CODE:%{http_code}" \
            "$url"); then
            
            http_code=$(echo "$response" | tail -n1 | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
            content=$(echo "$response" | sed '$d')
            size=${#content}
            
            echo "  â†’ HTTP Status: $http_code, Size: $size bytes"
            
            if [ "$http_code" = "200" ]; then
              if [[ "$content" == *"<rss"* ]] || [[ "$content" == *"<feed"* ]] || [[ "$content" == *"xml"* ]]; then
                echo "âœ… $name: Success - Valid RSS feed"
                return 0
              else
                echo "âš ï¸ $name: HTTP 200 but content doesn't look like RSS"
                echo "  â†’ Content preview: $(echo "$content" | head -c 100)..."
                return 1
              fi
            else
              echo "âŒ $name: HTTP error $http_code"
              return 1
            fi
          else
            echo "âŒ $name: Curl failed (network/timeout error)"
            return 1
          fi
        }
        
        # Track results
        success_count=0
        total_count=2
        
        # Fetch both feeds
        if fetch_feed "$UPCOMING_EVENTS" "Upcoming Events Feed"; then
          ((success_count++))
        fi
        
        echo "" # Empty line for readability
        
        if fetch_feed "$LATEST_NEWS" "Latest News Feed"; then
          ((success_count++))
        fi
        
        echo ""
        echo "ðŸ“Š Summary: $success_count/$total_count feeds successfully fetched"
        echo "ðŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        if [ $success_count -eq $total_count ]; then
          echo "ðŸŽ‰ All RSS feeds are healthy and active!"
          exit 0
        elif [ $success_count -gt 0 ]; then
          echo "âš ï¸ Some RSS feeds failed - but at least one is working"
          echo "ðŸ’¡ This is still success for keeping feeds alive!"
          exit 0
        else
          echo "ðŸš¨ All RSS feeds failed - immediate attention required!"
          exit 1
        fi