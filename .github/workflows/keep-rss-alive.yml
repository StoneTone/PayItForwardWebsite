name: Keep RSS Feeds Alive

on:
  schedule:
    - cron: '30 2 */3 * *'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  keep-feeds-alive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Fetch RSS Feeds
      shell: bash
      run: |
        set +e  # Don't exit on errors
        echo "ðŸ”„ Starting RSS keep-alive process..."
        
        # RSS feed URLs
        UPCOMING_EVENTS="https://fetchrss.com/feed/1vRIs41DtAOA1vRJ6l7Cu1MQ.rss"
        LATEST_NEWS="https://fetchrss.com/feed/1vRIs41DtAOA1vRJ7h57J7QQ.rss"
        
        # Function to fetch and validate RSS feed
        fetch_feed() {
          local url=$1
          local name=$2
          
          echo "ðŸ“¡ Fetching $name..."
          
          # Use simpler approach with just curl
          if response=$(curl -s --max-time 30 \
            -H "User-Agent: PayItForward-KeepAlive/1.0" \
            -H "Accept: application/xml, text/xml, */*" \
            -w "HTTP_CODE:%{http_code}" \
            "$url"); then
            
            http_code=$(echo "$response" | tail -n1 | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
            content=$(echo "$response" | sed '$d')
            size=${#content}
            
            echo "  â†’ HTTP Status: $http_code, Size: $size bytes"
            
            if [ "$http_code" = "200" ]; then
              if [[ "$content" == *"<rss"* ]] || [[ "$content" == *"<feed"* ]] || [[ "$content" == *"xml"* ]]; then
                echo "âœ… $name: Success - Valid RSS feed"
                return 0
              else
                echo "âš ï¸ $name: HTTP 200 but content doesn't look like RSS"
                echo "  â†’ Content preview: $(echo "$content" | head -c 100)..."
                return 1
              fi
            else
              echo "âŒ $name: HTTP error $http_code"
              return 1
            fi
          else
            echo "âŒ $name: Curl failed (network/timeout error)"
            return 1
          fi
        }
        
        # Track results
        success_count=0
        total_count=2
        
        # Track which feeds succeed/fail
        failed_feeds=()
        
        # Fetch both feeds
        echo "ðŸ§ª Testing Upcoming Events Feed..."
        if fetch_feed "$UPCOMING_EVENTS" "Upcoming Events Feed"; then
          success_count=$((success_count + 1))
          echo "  âœ… Upcoming Events Feed is healthy"
        else
          failed_feeds+=("Upcoming Events Feed")
          echo "  âŒ Upcoming Events Feed failed"
        fi
        
        echo "" # Empty line for readability
        
        echo "ðŸ§ª Testing Latest News Feed..."
        if fetch_feed "$LATEST_NEWS" "Latest News Feed"; then
          success_count=$((success_count + 1))
          echo "  âœ… Latest News Feed is healthy"
        else
          failed_feeds+=("Latest News Feed")
          echo "  âŒ Latest News Feed failed"
        fi
        
        echo ""
        echo "ðŸ“Š === FINAL RESULTS ==="
        echo "ðŸ“Š Summary: $success_count/$total_count feeds successfully fetched"
        echo "ðŸ• Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        if [ $success_count -eq $total_count ]; then
          echo ""
          echo "ðŸŽ‰ SUCCESS: All RSS feeds are healthy and active!"
          echo "âœ… Upcoming Events Feed: Working"
          echo "âœ… Latest News Feed: Working"
          echo ""
          echo "ðŸ’¡ Both feeds have been pinged and will not be deleted by FetchRSS"
          exit 0
        else
          echo ""
          echo "ðŸš¨ FAILURE: One or more RSS feeds are not working properly"
          echo ""
          echo "ðŸ“‹ Status breakdown:"
          if [[ ! " ${failed_feeds[@]} " =~ " Upcoming Events Feed " ]]; then
            echo "âœ… Upcoming Events Feed: Working"
          else
            echo "âŒ Upcoming Events Feed: FAILED"
          fi
          
          if [[ ! " ${failed_feeds[@]} " =~ " Latest News Feed " ]]; then
            echo "âœ… Latest News Feed: Working"
          else
            echo "âŒ Latest News Feed: FAILED"
          fi
          
          echo ""
          echo "ðŸ” Failed feeds (${#failed_feeds[@]}):"
          for feed in "${failed_feeds[@]}"; do
            echo "  â€¢ $feed"
          done
          
          echo ""
          echo "ðŸ› ï¸  Action required:"
          echo "  1. Check your FetchRSS dashboard"
          echo "  2. Verify the RSS URLs are still valid"
          echo "  3. Ensure Facebook pages are still public"
          echo "  4. Consider recreating failed feeds in FetchRSS"
          
          exit 1
        fi